---
title: 'Deep Dive: Radix UIì˜ React Presence ì»´í¬ë„ŒíŠ¸'
description: 'ë¦¬ì•¡íŠ¸ì—ì„œ ì–¸ë§ˆìš´íŠ¸ ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ Radix/ui ì»´í¬ë„ŒíŠ¸ íŒŒí—¤ì³ë³´ê¸°'
pubDate: '2025-01-20'
---

## ë“¤ì–´ê°€ë©°

ë¦¬ì•¡íŠ¸ëŠ” ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ DOMì—ì„œ í•´ë‹¹ ìš”ì†Œê°€ ë°”ë¡œ ì‚­ì œë˜ê¸° ë•Œë¬¸ì— <strong>fade-out</strong>ê³¼ ê°™ì€ ì• ë‹ˆë©”ì´ì…˜ì„ êµ¬í˜„í•˜ê¸°ê°€ ê¹Œë‹¤ë¡­ìŠµë‹ˆë‹¤.

ë¬¼ë¡  <strong>motion</strong>ì´ë‚˜ <strong>gsap</strong> ê°™ì€ ì• ë‹ˆë©”ì´ì…˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ì´ ë¬¸ì œë¥¼ ì‰½ê²Œ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ë‹¨ìˆœí•œ ê¸°ëŠ¥ í•˜ë‚˜ë¥¼ ìœ„í•´ ì´ëŸ¬í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ë©´ ë²ˆë“¤ ì‚¬ì´ì¦ˆê°€ ì»¤ì§„ë‹¤ëŠ” ë¶€ë‹´ì´ ìˆìŠµë‹ˆë‹¤.

ê·¸ë ‡ë‹¤ë©´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ìš°ë¦¬ê°€ ì›í•˜ëŠ”ëŒ€ë¡œ ì‘ë™í•˜ê²Œ í•˜ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œìš”? <br/>

## â setTimeout

ì—¬ê¸°ì„œ ì‰½ê²Œ ì €ì§€ë¥´ëŠ” ì‹¤ìˆ˜ ì¤‘ í•˜ë‚˜ëŠ” `setTimeout`ì„ ì‚¬ìš©í•˜ëŠ” ê±´ë°ìš”.

```tsx title="setTimeoutì„ í™œìš©í•œ unmount" showLineNumbers /100/$s /150/$s
function DelayUnmount({unmount, onClose}: {unmount: boolean, onClose: () => void)}) => {
  
  useEffect(() => {
    let id: NodeJS.Timeout;

    if (unmount) {
      id = setTimeout(() => {
        onClose()
      }, 100);
    }

    return () => clearTimeout(id)
  }, [unmount])
  
  return  <div className="duration-150 fade-out-animation"></div>
}
```

ìœ„ì— ë³´ì´ëŠ” ê²ƒì²˜ëŸ¼ ì–¸ë§ˆìš´íŠ¸ ì‹±í¬ë¥¼ ë§ì¶”ê¸° ìœ„í•´ `150ms`ì™€ `100ms`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. 
ê·¸ëŸ¬ë©´ ëª¨ë“  ê²Œ ì˜ ì‘ë™í• ê¹Œìš”? ì•„ì‰½ê²Œë„ ì•„ë‹™ë‹ˆë‹¤.

setTimeoutì„ ì‚¬ìš©í•œ ì–¸ë§ˆìš´íŠ¸ ì²˜ë¦¬ì˜ ì£¼ìš” ë¬¸ì œì ë“¤ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.


**1. íƒ€ì´ë° ì •í™•ë„ ë¬¸ì œ**

íƒ€ì´ë°ê³¼ ê´€ë ¨í•´ì„œ ë¸Œë¼ìš°ì €ë¥¼ ë¨¼ì € ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ëŠ” ì´ˆë‹¹ 60í”„ë ˆì„ì„ ëª©í‘œë¡œ ë™ì‘í•©ë‹ˆë‹¤. ì´ëŠ” ê° í”„ë ˆì„ë‹¹ ì•½ 16.67ms(ê¶Œì¥ 3ms) ì•ˆì— ë Œë”ë§ì´ ì™„ë£Œë˜ì–´ì•¼ ì‚¬ìš©ìì—ê²Œ ëŠê¹€ ì—†ëŠ” ê²½í—˜ì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ ë¸Œë¼ìš°ì €ì˜ ì´ë²¤íŠ¸ ë£¨í”„ëŠ” `ì½œ ìŠ¤íƒ -> ë§ˆì´í¬ë¡œíƒœìŠ¤í¬ í -> ë§¤í¬ë¡œíƒœìŠ¤í¬ í` ìˆœìœ¼ë¡œ ì‘ì—…ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤. 
ì´ëŠ” ë§¤í¬ë¡œíƒœìŠ¤í¬ íì—ì„œ ì²˜ë¦¬ë˜ëŠ” setTimeoutì´ ë‹¤ë¥¸ ì‹¤í–‰ ì¤‘ì¸ ì½”ë“œë‚˜ ë¸Œë¼ìš°ì €ì˜ ì„±ëŠ¥ì— ë”°ë¼ ì§€ì •ëœ ì‹œê°„ì— ì •í™•íˆ ì‹¤í–‰ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

**2. ì½”ë“œ ìœ ì§€ë³´ìˆ˜ì˜ ì–´ë ¤ì›€**

ì• ë‹ˆë©”ì´ì…˜ì˜ ì‹œê°„ì„ ìˆ˜ì •í•  ë•Œë§ˆë‹¤ setTimeoutì˜ ë”œë ˆì´ë„ í•¨ê»˜ ìˆ˜ì •í•´ì•¼ í•˜ëŠ”ë° ì´ëŠ” ì½”ë“œ ìœ ì§€ë³´ìˆ˜ ì‹œ ë¬¸ì œë¥¼ ì•¼ê¸°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ìš°ì„  ë‹¤ë¥¸ ê°œë°œìê°€ ì½”ë“œë¥¼ ê²€í† í•  ë•Œ ì´ëŸ¬í•œ ì—°ê´€ì„±ì„ ë†“ì¹˜ê¸° ì‰½ê³  ì´ë¡œ ì¸í•´ ì˜ë„í•˜ì§€ ì•Šì€ ë™ì‘ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
íŠ¹íˆ ì½”ë“œê°€ ë³µì¡í•´ì§ˆìˆ˜ë¡ ì´ëŸ¬í•œ ì»¤í”Œë§ ë¡œì§ì€ ìœ ì§€ë³´ìˆ˜ë¥¼ ë”ìš± ì–´ë µê²Œ ë§Œë“­ë‹ˆë‹¤.

**3. ì œì–´ê¶Œ**

ìœ„ì˜ ìƒí™©ë“¤ì„ í•´ê²°í•˜ê¸° ìœ„í•´ ê°œë°œìê°€ ì •êµí•˜ê²Œ íƒ€ì´ë°ì„ ì„¤ì •í•˜ê³  ìƒíƒœ ê´€ë¦¬ë¥¼ ì•„ë¬´ë¦¬ ì˜ í•˜ë”ë¼ë„ ì–¸ë§ˆìš´íŠ¸ì— ëŒ€í•œ ì œì–´ê¶Œì€ ê²°êµ­ ë¸Œë¼ìš°ì €ì—ê²Œ ìˆìŠµë‹ˆë‹¤.

íŠ¹íˆ ë³µì¡í•œ ì• ë‹ˆë©”ì´ì…˜ì´ë‚˜ ìƒíƒœ ì „í™˜ì´ í•„ìš”í•œ ê²½ìš° ì´ëŸ¬í•œ ì œì–´ê¶Œ ë¬¸ì œë¡œ ì¸í•´ ì• ë‹ˆë©”ì´ì…˜ì´ ë¶€ìì—°ìŠ¤ëŸ½ê²Œ ëŠê¸°ê±°ë‚˜ ìƒíƒœ ì—…ë°ì´íŠ¸ê°€ ì œëŒ€ë¡œ ë°˜ì˜ë˜ì§€ ì•ŠëŠ” ë“± ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ ë¸Œë¼ìš°ì €ì˜ ì´ë²¤íŠ¸ ë£¨í”„ì™€ ë³„ê°œë¡œ ê°œë°œìê°€ ì˜ë„í•œ ì‹œì ì— ì»´í¬ë„ŒíŠ¸ì˜ ë§ˆìš´íŠ¸/ì–¸ë§ˆìš´íŠ¸ë¥¼ ì œì–´í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì´ í•„ìš”í•©ë‹ˆë‹¤. 

ì´ë¥¼ ìœ„í•´ Radix UIëŠ” í•´ë‹¹ ë¬¸ì œë¥¼ ì–´ë–»ê²Œ í•´ê²°í–ˆëŠ”ì§€ <a href="https://github.com/radix-ui/primitives/tree/main/packages/react/presence/src" target="_black">ì½”ë“œ</a>ë¥¼ ë¶„ì„í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. 

## âœ… Presence Component(ì œì–´ê¶Œ)

```tsx showLineNumbers title="Presence.tsx" {19} /usePresence/#s
/* --- ìƒëµ --- */
interface PresenceProps {
  children: React.ReactElement | ((props: { present: boolean }) => React.ReactElement);
  present: boolean;
}

const Presence: React.FC<PresenceProps> = (props) => {
  const { present, children } = props;
  const presence = usePresence(present);

  const child = (
    typeof children === "function"
      ? children({ present: presence.isPresent })
      : React.Children.only(children)
  ) as React.ReactElement;

  const ref = useComposedRefs(presence.ref, getElementRef(child));
  const forceMount = typeof children === "function";
  return forceMount || presence.isPresent ? React.cloneElement(child, { ref }) : null;
};

Presence.displayName = "Presence";
```

ìš°ì„  returnë¬¸ì„ ë³´ë©´ forceMount í˜¹ì€ presenceê°€ ì¡´ì¬í•˜ë©´ ìì‹ ì»´í¬ë„ŒíŠ¸ë¥¼ ë³µì‚¬í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ì„œ ìš°ë¦¬ëŠ” `Presence` ì»´í¬ë„ŒíŠ¸ê°€ ìì‹ ì»´í¬ë„ŒíŠ¸ì˜ ë§ˆìš´íŠ¸/ì–¸ë§ˆìš´íŠ¸ë¥¼ ê´€ë¦¬í•˜ëŠ” ë˜í¼ í•¨ìˆ˜ì„ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.  

ì´ì œ ì œì–´ê¶Œì´ ë¸Œë¼ìš°ì €ì—ì„œ ì»´í¬ë„ŒíŠ¸ë¡œ ë„˜ì–´ì™”ìŠµë‹ˆë‹¤.

ì œì–´ê¶Œì„ ë„˜ê²¨ ë°›ì•˜ìœ¼ë‹ˆ ë§ˆìš´íŠ¸/ì–¸ë§ˆìš´íŠ¸ì— ëŒ€í•œ ìƒíƒœê´€ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì–´ëŠ ì‹œì ì— ë§ˆìš´íŠ¸í•˜ê³  ì–¸ë§ˆìš´íŠ¸ í•  ê²ƒì¸ì§€ `usePresence` í›…ì„ ì‚´í´ ë³´ê² ìŠµë‹ˆë‹¤.

```ts showLineNumbers title="usePresence.ts" /useStateMachine/#s {24}
function usePresence(present: boolean) {
  const [node, setNode] = React.useState<HTMLElement>();
  const stylesRef = React.useRef<CSSStyleDeclaration>({} as any);
  const prevPresentRef = React.useRef(present);
  const prevAnimationNameRef = React.useRef<string>("none");
  const initialState = present ? "mounted" : "unmounted";
  const [state, send] = useStateMachine(initialState, {
    mounted: {
      UNMOUNT: "unmounted",
      ANIMATION_OUT: "unmountSuspended",
    },
    unmountSuspended: {
      MOUNT: "mounted",
      ANIMATION_END: "unmounted",
    },
    unmounted: {
      MOUNT: "mounted",
    },
  });

  /* --- ìƒëµ  --- */

  return {
    isPresent: ["mounted", "unmountSuspended"].includes(state),
    ref: React.useCallback((node: HTMLElement) => {
      if (node) stylesRef.current = getComputedStyle(node);
      setNode(node);
    }, []),
  };
}
```
24ë²ˆì§¸ ì¤„ì„ ë³´ë©´ `useStateMachine`ì—ì„œ ë°˜í™˜í•œ ìƒíƒœê°€ mountedë‚˜ unmountSuspended ìƒíƒœì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.

ì—¬ê¸°ì„œ ì£¼ëª©í•  ì ì€ unmountSuspended ìƒíƒœì…ë‹ˆë‹¤. 

ì´ ìƒíƒœëŠ” ì»´í¬ë„ŒíŠ¸ê°€ ì œê±°ë˜ì–´ì•¼ í•˜ì§€ë§Œ, ì•„ì§ ì• ë‹ˆë©”ì´ì…˜ì´ ì™„ë£Œë˜ì§€ ì•Šì•„ ì ì‹œ ì–¸ë§ˆìš´íŠ¸ë¥¼ ë¯¸ë£¨ê³  ìˆëŠ” ìƒíƒœë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.

ê·¸ëŸ¬ë©´ ì´ì œ `ì–´ëŠ ìƒí™©`ì—ì„œ ìƒíƒœë¥¼ ì§€ì—°í•˜ê±°ë‚˜ ì–¸ë§ˆìš´íŠ¸ í˜¹ì€ ë§ˆìš´íŠ¸í•  ê²ƒì¸ì§€ `ìƒíƒœ ê´€ë¦¬`ë¥¼ í•˜ë©´ ë©ë‹ˆë‹¤.

ìš°ì„  ìƒíƒœ ê´€ë¦¬ë¥¼ ì–´ë–»ê²Œ êµ¬í˜„í–ˆëŠ”ì§€ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.

## âœ… useStateMachine with Typescript(ì •í™•ë„)

ì½”ë“œëŠ” ê°„ë‹¨í•˜ì§€ë§Œ íƒ€ì…ì´ ìƒë‹¹íˆ ì–´ë µìŠµë‹ˆë‹¤.

```ts showLineNumbers title="useStateMachine.ts" {3,4,16}
import * as React from "react";

type Machine<S> = { [k: string]: { [k: string]: S } };
type MachineState<T> = keyof T;
type MachineEvent<T> = keyof UnionToIntersection<T[keyof T]>;

// ğŸ¤¯ https://fettblog.eu/typescript-union-to-intersection/
type UnionToIntersection<T> = (T extends unknown ? (x: T) => unknown : never) extends (
  x: infer R
) => unknown
  ? R
  : never;

export function useStateMachine<M>(
  initialState: MachineState<M>,
  machine: M & Machine<MachineState<M>>
) {
  return React.useReducer((state: MachineState<M>, event: MachineEvent<M>): MachineState<M> => {
    const nextState = (machine[state] as any)[event];
    return nextState ?? state;
  }, initialState);
}

```

ìœ„ì—ì„œ í™•ì¸í•´ì•¼ í•  ë¶€ë¶„ì€ `machin`ì´ ì–´ë–¤ êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ì´ë¥¼ íƒ€ì…ìœ¼ë¡œ ì–´ë–»ê²Œ ë³´ì¥í•˜ëŠ”ê°€ì…ë‹ˆë‹¤.

ìš°ì„  `machine: M & Machine<MachineState<M>>`ì„ íŒŒì•…í•˜ê² ìŠµë‹ˆë‹¤.


`MachineState<M>`ì€ M íƒ€ì… ê°ì²´ì˜ í‚¤ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ `Machine<MachineState<M>>`ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```ts 
type Machine<MachineState<M>> = { [k: string]: { [k: string]:  keyof M } };
```

ì´ì œ `M &`ìœ¼ë¡œ ì¸í•´ ê°ì²´ì˜ ìµœìƒìœ„ í‚¤ì™€ ìµœí•˜ìœ„ ë°¸ë¥˜ê°€ ì„œë¡œ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.

```ts showLineNumbers /"mounted"/$s /"unmounted"/$s /"unmountSuspended"/$s /unmounted/#s /unmountSuspended/#s /mounted/#s  title=" M & Machine<MachineState<M>>"
{
  mounted: {
    UNMOUNT: "unmounted",
    ANIMATION_OUT: "unmountSuspended"
  }
  unmountSuspended: {
    MOUNT: "mounted",
    ANIMATION_END: "unmounted"
  }
  unmounted: {
    MOUNT : "mounted"
  }
}
```

ì´ì œ machin êµ¬ì¡°ê°€ ë³´ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.

`event` íƒ€ì…ì„ í™•ì¸í•˜ê¸° ì „ì— ì™œ ì´ëŸ° êµ¬ì¡°ë¥¼ ê°€ì¡ŒëŠ”ì§€ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.

ë§Œì•½ `state`ê°€ <strong>mounted</strong>ë¡œ ë“¤ì–´ì˜¬ ê²½ìš° <strong>UNMOUNT</strong>, <strong>ANIMATION_OUT</strong>ì„ í†µí•´ ë‹¤ìŒ ë Œë”ë§ì— ëŒ€í•œ `ìƒíƒœ ê´€ë¦¬`ê°€ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.

ì´ë¥¼ í†µí•´ì„œ ìš°ë¦¬ëŠ” `setTimeout`ìœ¼ë¡œ ê´€ë¦¬í•˜ë˜ ë¶ˆì•ˆì •í•œ ë°©ì‹ì—ì„œ ë²—ì–´ë‚˜ ë¦¬ì•¡íŠ¸ ë Œë”ë§ ì‚¬ì´í´ ì•ˆì—ì„œ `ì–´ëŠ ìƒí™©`ì— ëŒ€í•œ ëŒ€ì²˜ê°€ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.

ì´ì œ `event` íƒ€ì…ì„ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.

```ts title="event"
type MachineEvent<T> = keyof UnionToIntersection<T[keyof T]>;

// ğŸ¤¯ https://fettblog.eu/typescript-union-to-intersection/
type UnionToIntersection<T> = (T extends any ? (x: T) => any : never) extends (x: infer R) => any
  ? R
  : never;
```

ìš°ì„  `keyof UnionToIntersection<T[keyof T]>`ì˜ ê²°ê³¼ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ `UnionType`ì„ ì‚¬ìš©í•´ ë³´ê² ìŠµë‹ˆë‹¤.

```ts showLineNumbers title="type UnionType<T> = T[keyof T]" /M & Machine<MachineState<M>>/$
 /* type E = UnionType<typeof M & Machine<MachineState<M>>> */
type E = {
    UNMOUNT: string;
    ANIMATION_OUT: string;
} | {
    MOUNT: string;
    ANIMATION_END: string;
} | {
    MOUNT: string;
}

type T = keyof E // never
```

ìœ„ì™€ ê°™ì´ ìœ ë‹ˆì˜¨ íƒ€ì…ì€ ê³µí†µì˜ í‚¤ê°€ ì—†ì„ ê²½ìš° `never` íƒ€ì…ì„ ë°˜í™˜í•˜ê¸° ë•Œë¬¸ì— êµì°¨ íƒ€ì…ìœ¼ë¡œ ë§Œë“¤ì–´ íƒ€ì…ì„ ë³´ì¥í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.

<strong>UnionToIntersection</strong>ì— ëŒ€í•œ ìƒì„¸í•œ ì„¤ëª…ì€ <a href="https://fettblog.eu/typescript-union-to-intersection/" target="_black">ë¸”ë¡œê·¸</a>ë‚˜ <a href="https://github.com/type-challenges/type-challenges/issues/122" target="_blank">type-challenges</a>ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.

```ts title="UnionToIntersection"
type I = UnionToIntersection<'foo' | 42 | true> // expected to be 'foo' & 42 & true
```

êµì°¨ íƒ€ì…ìœ¼ë¡œ í‚¤ íƒ€ì…ì„ ë°˜í™˜í•  ê²½ìš° ìš°ë¦¬ê°€ ì›í•˜ëŠ” ìƒí™©, ì¦‰ `ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ`ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

```ts title="MachineEvent<M>"
type event = "UNMOUNT" | "ANIMATION_OUT" | "MOUNT" | "ANIMATION_END"
```

ì´ì œ ìš°ë¦¬ê°€ ì›í•˜ëŠ” ìƒí™©ê³¼ íƒ€ì…ì„ ë³´ì¥ ë°›ì•˜ìœ¼ë‹ˆ ê²°ê³¼ë¥¼ ë°˜í™˜í•˜ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤.

```ts title="reducerë¥¼ í†µí•œ ìƒíƒœ ë°˜í™˜"
  return React.useReducer((state: MachineState<M>, event: MachineEvent<M>): MachineState<M> => {
    const nextState = (machine[state] as any)[event];
    return nextState ?? state;
  }, initialState);
```

## âœ… ìƒíƒœ ì—…ë°ì´íŠ¸(ìœ ì§€ë³´ìˆ˜)

setTimeoutì„ í™œìš©í•  ê²½ìš° ìœ ì§€ë³´ìˆ˜ê°€ ì–´ë ¤ìš´ ì ì„ ì•ì„œ í™•ì¸í–ˆìŠµë‹ˆë‹¤. (ì»¤í”Œë§, ì½”ë“œ ë³µì¡ë„ì— ì˜í•œ ê°€ë…ì„± ì €í•˜)

í•˜ì§€ë§Œ ì œì–´ê¶Œê³¼ ì •í™•ë„ë¥¼ ì»¤ìŠ¤í…€ ì»´í¬ë„ŒíŠ¸ë¡œ ë¶„ë¦¬í•¨ìœ¼ë¡œì¨ ê°œë°œìëŠ” í•„ìš”í•œ ë¶€ë¶„ë§Œ ì‹ ê²½ì„ ì“°ë©´ ë˜ê¸° ë•Œë¬¸ì— ìœ ì§€ë³´ìˆ˜ê°€ ë”ìš± í¸ë¦¬í•´ì¡ŒìŠµë‹ˆë‹¤.

ì—¬ê¸°ì„œëŠ” `useEffect`ì™€ `useLayoutEffect`ì˜ ì˜ì¡´ì„± ë°°ì—´ì„ ê¸°ì¤€ìœ¼ë¡œ ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ì–´ë–»ê²Œ í•˜ëŠ”ì§€ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.

```tsx title="[state]" showLineNumbers
  const stylesRef = React.useRef<CSSStyleDeclaration>({} as any);
  const prevAnimationNameRef = React.useRef<string>("none");
  /* --- ìƒëµ --- */
  React.useEffect(() => {
    const currentAnimationName = getAnimationName(stylesRef.current);
    prevAnimationNameRef.current = state === "mounted" ? currentAnimationName : "none";
  }, [state]);
```
ìš”ì†Œê°€ ì²˜ìŒ ë§ˆìš´íŠ¸ë˜ê±°ë‚˜ ë‹¤ì‹œ ë§ˆìš´íŠ¸ë  ê²½ìš° í•´ë‹¹ ì‹œì ì˜ ì• ë‹ˆë©”ì´ì…˜ ì´ë¦„ì„ ì €ì¥í•˜ëŠ” ê±¸ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ëŠ” ì–¸ë§ˆìš´íŠ¸ ì‹œ ì• ë‹ˆë©”ì´ì…˜ ë³€í™”ë¥¼ ê°ì§€í•˜ëŠ” ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

```tsx title="[present, send]" showLineNumbers
useLayoutEffect(() => {
  /* --- ìƒëµ --- */
  const prevAnimationName = prevAnimationNameRef.current;
  const currentAnimationName = getAnimationName(styles);
  
  const isAnimating = prevAnimationName !== currentAnimationName;
  /* --- ìƒëµ --- */
}, [present, send]);
```

ì´í›„ ì¡°ê±´ë¬¸ë“¤ì„ í†µí•´ ìƒí™©ì— ë§ê²Œ machin eventë¡œ ë Œë”ë§ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

```tsx title="[present, send]" showLineNumbers {6, 10, 12, 16, 25, 27}
useLayoutEffect(() => {
  const styles = stylesRef.current;
  const wasPresent = prevPresentRef.current;
  const hasPresentChanged = wasPresent !== present;

  if (hasPresentChanged) {
    const prevAnimationName = prevAnimationNameRef.current;
    const currentAnimationName = getAnimationName(styles);

    if (present) {
      send("MOUNT");
    } else if (currentAnimationName === "none" || styles?.display === "none") {
      // If there is no exit animation or the element is hidden, animations won't run
      // so we unmount instantly
      send("UNMOUNT");
    } else {
      /**
       * When `present` changes to `false`, we check changes to animation-name to
       * determine whether an animation has started. We chose this approach (reading
       * computed styles) because there is no `animationrun` event and `animationstart`
       * fires after `animation-delay` has expired which would be too late.
       */
      const isAnimating = prevAnimationName !== currentAnimationName;

      if (wasPresent && isAnimating) {
        send("ANIMATION_OUT");
      } else {
        send("UNMOUNT");
      }
    }

    prevPresentRef.current = present;
  }
}, [present, send]);
```

DOM ë…¸ë“œì— ëŒ€í•œ `useLayoutEffect`ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```tsx title="[node, send]" showLineNumbers {9-11}
const [node, setNode] = React.useState<HTMLElement>();

useLayoutEffect(() => {
  if (node) {
    const handleAnimationEnd = (event: AnimationEvent) => {
      const currentAnimationName = getAnimationName(stylesRef.current);
      const isCurrentAnimation = currentAnimationName.includes(event.animationName);
    if (event.target === node && isCurrentAnimation) {
        // With React 18 concurrency this update is applied
        // a frame after the animation ends, creating a flash of visible content.
        // By manually flushing we ensure they sync within a frame, removing the flash.
        ReactDOM.flushSync(() => send("ANIMATION_END"));
      }
    };
    const handleAnimationStart = (event: AnimationEvent) => {
      if (event.target === node) {
        prevAnimationNameRef.current = getAnimationName(stylesRef.current);
      }
    };
    // ... ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ë° ì œê±°
  }
}, [node, send]);
```

ì—¬ê¸°ì„œëŠ” Reactì˜ ë™ì‹œì„± ë¬¸ì œë¡œ ì¸í•œ ìƒíƒœ ì—…ë°ì´íŠ¸ ì§€ì—°ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ <a href="https://react.dev/reference/react-dom/flushSync" target="_blank">flushSync</a>ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

ì´ì™¸ì˜ ìƒíƒœ ì—…ë°ì´íŠ¸ëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì—ê²Œ ìœ„ì„í•˜ì—¬ ì• ë‹ˆë©”ì´ì…˜ì˜ ì‹œì‘ê³¼ ì¢…ë£Œë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.

ê° ì˜ì¡´ì„± ë°°ì—´ì„ ê¸°ì¤€ìœ¼ë¡œ ì¢…í•©í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

**[state] ì˜ì¡´ì„±**

- ì»´í¬ë„ŒíŠ¸ì˜ ë§ˆìš´íŠ¸ ìƒíƒœê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ í˜„ì¬ ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœë¥¼ ì¶”ì 
- ì´ì „ ì• ë‹ˆë©”ì´ì…˜ ì´ë¦„ì„ ì €ì¥í•˜ì—¬ ë³€í™” ê°ì§€ì˜ ê¸°ì¤€ì  ì œê³µ

**[present, send] ì˜ì¡´ì„±**

- present propì˜ ë³€ê²½ì„ ê°ì§€í•˜ì—¬ ë§ˆìš´íŠ¸/ì–¸ë§ˆìš´íŠ¸ ì „í™˜ì„ ì²˜ë¦¬
- ì´ì „ì— ì €ì¥ëœ ì• ë‹ˆë©”ì´ì…˜ ì´ë¦„ê³¼ í˜„ì¬ ìƒíƒœë¥¼ ë¹„êµí•˜ì—¬ ì ì ˆí•œ ìƒíƒœ ì „ì´ ê²°ì •

**[node, send] ì˜ì¡´ì„±**

- DOM ë…¸ë“œì— ëŒ€í•œ ì‹¤ì œ ì• ë‹ˆë©”ì´ì…˜ ì´ë²¤íŠ¸ ê°ì§€ ë° ì²˜ë¦¬
- ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘/ì¢…ë£Œ ì‹œì ì— ì ì ˆí•œ ìƒíƒœ ì—…ë°ì´íŠ¸ ìˆ˜í–‰


## ë‚˜ê°€ë©°

ë¦¬ì•¡íŠ¸ì˜ ì–¸ë§ˆìš´íŠ¸ ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ setTimeoutì„ ì‚¬ìš©í•˜ë©´ ë‹¹ì¥ì€ ê°„í¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

í˜¹ì€ requestAnimationFrameì„ ì‚¬ìš©í•˜ë©´ ë˜ëŠ” ê±° ì•„ë‹ˆì•¼?ë¼ê³  ìƒê°í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ **ì œì–´ê¶Œ**, **ì •í™•ë„**, **ìœ ì§€ë³´ìˆ˜** ì¸¡ë©´ì—ì„œ ë³´ë©´ ê·¸ë ‡ì§€ ì•ŠìŠµë‹ˆë‹¤.

ì´ëŸ¬í•œ ë¬¸ì œì ë“¤ì„ í•´ê²°í•˜ê¸° ìœ„í•´ ìš°ë¦¬ëŠ” CSS ì• ë‹ˆë©”ì´ì…˜ê³¼ ìƒíƒœ ë¨¸ì‹ ì„ ê²°í•©í•œ ì ‘ê·¼ ë°©ì‹ì„ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤.

ëìœ¼ë¡œ ì‚¬ìš© ì˜ˆì‹œë¥¼ í™•ì¸í•˜ë©° ê¸€ì„ ë§ˆì¹˜ê² ìŠµë‹ˆë‹¤.

```tsx title="PresenceExample.tsx" showLineNumbers {7, 9}
export default function PresenceExample() {
  const [open, setOpen] = useState(false);

  return (
    <div>
      <button onClick={() => setOpen(true)}>open</button>
      <Presence present={open}>
        <div
          data-state={open ? "open" : "closed"}
          className="overlay"
          onClick={() => setOpen(false)}
        />
      </Presence>
    </div>
  );
}

```

```CSS title="styles.css" showLineNumbers {7}
.overlay {
  position: fixed;
  inset: 0;
  background: blue;
  animation: fadeIn 0.5s;

  &[data-state="closed"] {
    animation: fadeOut 0.5s;
  }
}
```